name: Daily Data Ingestion

# Once per day - slow-changing sources and enrichment
# Runs at 3:00 AM UTC to avoid peak hours

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # THREAT ACTOR DATABASES
  # ============================================
  ingest-actors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Ingest Malpedia
        run: npm run ingest:malpedia
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Ingest MISP Galaxy
        run: npm run ingest:misp-galaxy
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Summary
        if: always()
        run: echo "Actor ingestion completed at $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # DAILY SCORING & ENRICHMENT
  # ============================================
  ingest-scoring:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # EPSS scores update daily
      - name: Ingest EPSS scores
        run: npm run ingest:epss
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      # Prioritize vulnerabilities based on new scores
      - name: Prioritize vulnerabilities
        run: npm run prioritize:vulnerabilities
        continue-on-error: true
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Summary
        if: always()
        run: echo "Scoring completed at $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # IP REPUTATION & BLOCKLISTS
  # ============================================
  ingest-reputation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Ingest Tor exit nodes
        run: npm run ingest:tor-exits
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Ingest Firehol blocklists
        run: npm run ingest:firehol
        continue-on-error: true
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Ingest blocklist.de
        run: npm run ingest:blocklist-de
        continue-on-error: true
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Aggregate IP reputation
        run: npm run aggregate:ip-reputation
        continue-on-error: true
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Summary
        if: always()
        run: echo "Reputation ingestion completed at $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # ENRICHMENT (uses API quotas sparingly)
  # ============================================
  enrichment:
    runs-on: ubuntu-latest
    needs: [ingest-reputation]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Censys enriches existing IPs (free tier: 50/day)
      - name: Enrich with Censys
        run: npm run ingest:censys
        continue-on-error: true
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          CENSYS_API_KEY: ${{ secrets.CENSYS_API_KEY }}

      # Shodan InternetDB (free, no API key needed)
      - name: Enrich with Shodan InternetDB
        run: npm run enrich:shodan
        continue-on-error: true
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Summary
        if: always()
        run: echo "Enrichment completed at $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # SUMMARY
  # ============================================
  notify-completion:
    runs-on: ubuntu-latest
    needs: [ingest-actors, ingest-scoring, ingest-reputation, enrichment]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Daily Ingestion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Actors | ${{ needs.ingest-actors.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Scoring | ${{ needs.ingest-scoring.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Reputation | ${{ needs.ingest-reputation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Enrichment | ${{ needs.enrichment.result }} |" >> $GITHUB_STEP_SUMMARY
