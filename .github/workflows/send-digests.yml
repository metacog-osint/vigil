# Send digest emails on schedule
name: Send Digests

on:
  schedule:
    # Daily digests at 8 AM UTC
    - cron: '0 8 * * *'
    # Weekly digests on Monday at 8 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      type:
        description: 'Digest type to send'
        required: true
        default: 'weekly'
        type: choice
        options:
          - daily
          - weekly
      dry_run:
        description: 'Dry run (no emails sent)'
        required: false
        default: false
        type: boolean

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

jobs:
  send-digests:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --production

      - name: Determine digest type
        id: type
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "type=${{ inputs.type }}" >> $GITHUB_OUTPUT
          elif [ "$(date +%u)" == "1" ]; then
            # Monday - send weekly digest
            echo "type=weekly" >> $GITHUB_OUTPUT
          else
            # Other days - send daily digest
            echo "type=daily" >> $GITHUB_OUTPUT
          fi

      - name: Send digests
        run: |
          FLAGS="--type=${{ steps.type.outputs.type }}"
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            FLAGS="$FLAGS --dry-run"
          fi
          node scripts/send-digests.mjs $FLAGS

      - name: Report results
        if: always()
        run: |
          echo "## Digest Send Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** ${{ steps.type.outputs.type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
