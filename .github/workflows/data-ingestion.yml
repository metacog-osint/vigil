name: Main Data Ingestion

# Every 6 hours - IOC and vulnerability feeds
# Consolidated jobs to minimize GitHub Actions minutes
# Note: Ransomware + ThreatFox run hourly in critical-alerts workflow

on:
  schedule:
    # Every 6 hours at minute 0
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      source:
        description: 'Data source to ingest (leave empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - iocs
          - vulnerabilities

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # IOC FEEDS (Consolidated)
  # ============================================
  ingest-iocs:
    runs-on: ubuntu-latest
    if: github.event.inputs.source == '' || github.event.inputs.source == 'iocs'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Abuse.ch feeds
      - name: Ingest URLhaus
        run: npm run ingest:urlhaus
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Ingest Feodo C2
        run: npm run ingest:feodo
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Ingest Abuse.ch
        run: npm run ingest:abusech
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Ingest MalwareBazaar
        run: npm run ingest:malwarebazaar
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      # Additional IOC feeds
      - name: Ingest Pulsedive
        run: npm run ingest:pulsedive
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          PULSEDIVE_API_KEY: ${{ secrets.PULSEDIVE_API_KEY }}

      - name: Ingest OpenPhish
        run: npm run ingest:openphish
        continue-on-error: true
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Ingest C2 Tracker
        run: npm run ingest:c2-tracker
        continue-on-error: true
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Summary
        if: always()
        run: echo "IOC ingestion completed at $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # VULNERABILITY FEEDS (Consolidated)
  # ============================================
  ingest-vulnerabilities:
    runs-on: ubuntu-latest
    if: github.event.inputs.source == '' || github.event.inputs.source == 'vulnerabilities'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Ingest CISA KEV
        run: npm run ingest:kev
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Ingest VulnCheck KEV
        run: npm run ingest:vulncheck
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VULNCHECK_API_KEY: ${{ secrets.VULNCHECK_API_KEY }}

      - name: Ingest NVD
        run: npm run ingest:nvd
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Ingest CISA Alerts
        run: npm run ingest:cisa-alerts
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Summary
        if: always()
        run: echo "Vulnerability ingestion completed at $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # POST-PROCESSING
  # ============================================
  post-processing:
    runs-on: ubuntu-latest
    needs: [ingest-iocs, ingest-vulnerabilities]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Seed correlations
        run: npm run seed:correlations
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Calculate trends
        run: |
          curl -s -X POST "${{ secrets.VITE_SUPABASE_URL }}/rest/v1/rpc/apply_actor_trends" \
            -H "apikey: ${{ secrets.VITE_SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.VITE_SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" || true

      - name: Snapshot actor trends
        run: npm run snapshot:actors
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Summary
        if: always()
        run: |
          echo "## Main Data Ingestion Summary" >> $GITHUB_STEP_SUMMARY
          echo "Completed at $(date -u)" >> $GITHUB_STEP_SUMMARY
