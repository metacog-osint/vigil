-- Migration 058: Malware Families Table
-- Tracks malware family metadata and trends from ANY.RUN and other sources

CREATE TABLE IF NOT EXISTS malware_families (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT UNIQUE NOT NULL,
  type TEXT, -- rat, stealer, loader, ransomware, botnet, backdoor, etc.
  description TEXT,
  aliases TEXT[] DEFAULT '{}',

  -- Activity tracking
  first_seen TIMESTAMPTZ,
  last_seen TIMESTAMPTZ,
  is_active BOOLEAN DEFAULT true,

  -- Metrics from sources like ANY.RUN
  sample_count INTEGER DEFAULT 0,
  weekly_activity INTEGER DEFAULT 0,
  trend_direction TEXT, -- up, down, stable

  -- Relationships
  associated_actors TEXT[] DEFAULT '{}',

  -- Source info
  source TEXT DEFAULT 'anyrun-trends',
  source_url TEXT,

  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_malware_families_name ON malware_families(name);
CREATE INDEX IF NOT EXISTS idx_malware_families_type ON malware_families(type);
CREATE INDEX IF NOT EXISTS idx_malware_families_active ON malware_families(is_active);
CREATE INDEX IF NOT EXISTS idx_malware_families_last_seen ON malware_families(last_seen DESC);

-- RLS
ALTER TABLE malware_families ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public read access to malware_families"
  ON malware_families FOR SELECT
  USING (true);

CREATE POLICY "Allow service role write access to malware_families"
  ON malware_families FOR ALL
  USING (auth.role() = 'service_role');

-- Update timestamp trigger
CREATE OR REPLACE FUNCTION update_malware_families_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_malware_families_updated_at
  BEFORE UPDATE ON malware_families
  FOR EACH ROW
  EXECUTE FUNCTION update_malware_families_updated_at();

COMMENT ON TABLE malware_families IS 'Malware family metadata and activity trends from ANY.RUN and other sources';
