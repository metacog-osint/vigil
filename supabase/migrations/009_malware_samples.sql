-- Migration 009: Malware Samples Table
-- Stores malware sample metadata from MalwareBazaar and other sources

-- ============================================
-- MALWARE SAMPLES TABLE
-- Stores file hash information and metadata
-- ============================================
CREATE TABLE IF NOT EXISTS malware_samples (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  sha256 TEXT NOT NULL UNIQUE,
  sha1 TEXT,
  md5 TEXT,
  filename TEXT,
  file_type TEXT,
  file_size BIGINT,
  signature TEXT,
  tags TEXT[] DEFAULT '{}',
  first_seen TIMESTAMPTZ,
  last_seen TIMESTAMPTZ,
  source TEXT DEFAULT 'malwarebazaar',
  reporter TEXT,
  delivery_method TEXT,
  actor_id UUID REFERENCES threat_actors(id) ON DELETE SET NULL,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for efficient lookups
CREATE INDEX IF NOT EXISTS idx_malware_samples_sha256 ON malware_samples(sha256);
CREATE INDEX IF NOT EXISTS idx_malware_samples_sha1 ON malware_samples(sha1);
CREATE INDEX IF NOT EXISTS idx_malware_samples_md5 ON malware_samples(md5);
CREATE INDEX IF NOT EXISTS idx_malware_samples_signature ON malware_samples(signature);
CREATE INDEX IF NOT EXISTS idx_malware_samples_first_seen ON malware_samples(first_seen DESC);
CREATE INDEX IF NOT EXISTS idx_malware_samples_actor_id ON malware_samples(actor_id);

-- ============================================
-- ADD MALWARE FAMILY COLUMN TO IOCS
-- Links IOCs to malware families
-- ============================================
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
                 WHERE table_name = 'iocs' AND column_name = 'malware_family') THEN
    ALTER TABLE iocs ADD COLUMN malware_family TEXT;
  END IF;
END $$;

CREATE INDEX IF NOT EXISTS idx_iocs_malware_family ON iocs(malware_family);

-- ============================================
-- VIEWS
-- ============================================

-- View for malware family statistics
CREATE OR REPLACE VIEW malware_family_stats AS
SELECT
  COALESCE(signature, 'Unknown') as family,
  COUNT(*) as sample_count,
  MIN(first_seen) as first_seen,
  MAX(last_seen) as last_seen,
  COUNT(DISTINCT actor_id) as associated_actors,
  array_agg(DISTINCT unnest_tags) FILTER (WHERE unnest_tags IS NOT NULL) as common_tags
FROM malware_samples,
LATERAL unnest(tags) AS unnest_tags
GROUP BY signature
ORDER BY sample_count DESC;

-- View for recent malware samples
CREATE OR REPLACE VIEW recent_malware_samples AS
SELECT
  id,
  sha256,
  filename,
  file_type,
  signature as family,
  tags,
  first_seen,
  source,
  metadata
FROM malware_samples
WHERE first_seen >= NOW() - INTERVAL '30 days'
ORDER BY first_seen DESC;

-- ============================================
-- ENABLE RLS
-- ============================================
ALTER TABLE malware_samples ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public read access for malware_samples" ON malware_samples
  FOR SELECT USING (true);
