-- Vulnerability Priority Scoring
-- Adds calculated priority fields for risk-based vulnerability management

-- Add priority scoring fields
ALTER TABLE vulnerabilities ADD COLUMN IF NOT EXISTS priority_score DECIMAL(5,2);
ALTER TABLE vulnerabilities ADD COLUMN IF NOT EXISTS priority_level TEXT CHECK (priority_level IN ('critical', 'high', 'medium', 'low', 'info'));
ALTER TABLE vulnerabilities ADD COLUMN IF NOT EXISTS priority_factors JSONB DEFAULT '[]';
ALTER TABLE vulnerabilities ADD COLUMN IF NOT EXISTS priority_calculated_at TIMESTAMPTZ;

-- Index for priority-based queries
CREATE INDEX IF NOT EXISTS idx_vulnerabilities_priority_score ON vulnerabilities(priority_score DESC NULLS LAST);
CREATE INDEX IF NOT EXISTS idx_vulnerabilities_priority_level ON vulnerabilities(priority_level);

-- Comments
COMMENT ON COLUMN vulnerabilities.priority_score IS 'Calculated priority score 0-100 based on EPSS, CVSS, KEV, exploits, recency';
COMMENT ON COLUMN vulnerabilities.priority_level IS 'Priority level derived from score: critical (70+), high (50-70), medium (30-50), low (15-30), info (<15)';
COMMENT ON COLUMN vulnerabilities.priority_factors IS 'Array of factors contributing to score with points breakdown';
