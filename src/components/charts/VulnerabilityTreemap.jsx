import { useState, useEffect, useMemo } from 'react'
import { Treemap, ResponsiveContainer, Tooltip } from 'recharts'
import { supabase } from '../../lib/supabase'

// Color mapping based on KEV status and severity
const getColor = (item) => {
  if (item.kev_date) {
    // KEV - red shades based on CVSS
    if (item.cvss_score >= 9) return '#dc2626' // Red-600
    if (item.cvss_score >= 7) return '#ef4444' // Red-500
    return '#f87171' // Red-400
  } else {
    // Non-KEV - orange shades
    if (item.cvss_score >= 9) return '#ea580c' // Orange-600
    if (item.cvss_score >= 7) return '#f97316' // Orange-500
    if (item.cvss_score >= 4) return '#fb923c' // Orange-400
    return '#fdba74' // Orange-300
  }
}

// Custom content renderer for treemap cells
const CustomizedContent = (props) => {
  const { x, y, width, height, name, cvss_score, kev_date } = props

  if (width < 30 || height < 20) return null

  return (
    <g>
      <rect
        x={x}
        y={y}
        width={width}
        height={height}
        style={{
          fill: getColor({ cvss_score, kev_date }),
          stroke: '#1f2937',
          strokeWidth: 1,
        }}
      />
      {width > 60 && height > 30 && (
        <>
          <text
            x={x + width / 2}
            y={y + height / 2 - 6}
            textAnchor="middle"
            fill="#fff"
            fontSize={10}
            fontWeight="bold"
          >
            {name?.length > 15 ? name.substring(0, 15) + '...' : name}
          </text>
          <text
            x={x + width / 2}
            y={y + height / 2 + 8}
            textAnchor="middle"
            fill="#d1d5db"
            fontSize={9}
          >
            CVSS: {cvss_score?.toFixed(1) || 'N/A'}
          </text>
          {kev_date && (
            <text
              x={x + width / 2}
              y={y + height / 2 + 20}
              textAnchor="middle"
              fill="#fca5a5"
              fontSize={8}
            >
              KEV
            </text>
          )}
        </>
      )}
    </g>
  )
}

// Custom tooltip
const CustomTooltip = ({ active, payload }) => {
  if (!active || !payload?.[0]) return null

  const data = payload[0].payload

  return (
    <div className="bg-gray-900 border border-gray-700 rounded-lg shadow-xl p-3 max-w-xs">
      <div className="font-mono text-cyan-400 text-sm mb-1">{data.name}</div>
      <div className="flex items-center gap-2 mb-2">
        <span className={`text-xs px-2 py-0.5 rounded ${
          data.cvss_score >= 9 ? 'bg-red-500/20 text-red-400' :
          data.cvss_score >= 7 ? 'bg-orange-500/20 text-orange-400' :
          data.cvss_score >= 4 ? 'bg-yellow-500/20 text-yellow-400' :
          'bg-blue-500/20 text-blue-400'
        }`}>
          CVSS: {data.cvss_score?.toFixed(1) || 'N/A'}
        </span>
        {data.kev_date && (
          <span className="text-xs px-2 py-0.5 rounded bg-red-500/20 text-red-400">
            KEV
          </span>
        )}
      </div>
      {data.description && (
        <p className="text-xs text-gray-400 line-clamp-3">{data.description}</p>
      )}
      {data.affected_vendors?.length > 0 && (
        <div className="text-xs text-gray-500 mt-1">
          Vendors: {data.affected_vendors.slice(0, 3).join(', ')}
        </div>
      )}
    </div>
  )
}

export default function VulnerabilityTreemap({
  days = 90,
  groupBy = 'vendor', // 'vendor' | 'severity' | 'flat'
  kevOnly = false,
  limit = 100,
  height = 400,
  onCveClick,
}) {
  const [vulnerabilities, setVulnerabilities] = useState([])
  const [loading, setLoading] = useState(true)
  const [selectedVendor, setSelectedVendor] = useState(null)

  useEffect(() => {
    async function fetchData() {
      setLoading(true)

      let query = supabase
        .from('vulnerabilities')
        .select('cve_id, cvss_score, description, affected_vendors, kev_date, epss_score')
        .not('cvss_score', 'is', null)
        .order('cvss_score', { ascending: false })
        .limit(limit)

      if (kevOnly) {
        query = query.not('kev_date', 'is', null)
      }

      if (days > 0) {
        const cutoffDate = new Date()
        cutoffDate.setDate(cutoffDate.getDate() - days)
        query = query.or(`kev_date.gte.${cutoffDate.toISOString()},created_at.gte.${cutoffDate.toISOString()}`)
      }

      const { data } = await query

      if (data) {
        setVulnerabilities(data)
      }

      setLoading(false)
    }

    fetchData()
  }, [days, kevOnly, limit])

  // Transform data for treemap
  const treemapData = useMemo(() => {
    if (groupBy === 'flat') {
      // Flat view - each CVE is a cell
      return vulnerabilities.map(v => ({
        name: v.cve_id,
        size: Math.max(v.cvss_score || 1, 1) * 10,
        cvss_score: v.cvss_score,
        kev_date: v.kev_date,
        description: v.description,
        affected_vendors: v.affected_vendors,
      }))
    }

    if (groupBy === 'severity') {
      // Group by severity
      const groups = {
        critical: { name: 'Critical (9.0+)', children: [], color: '#dc2626' },
        high: { name: 'High (7.0-8.9)', children: [], color: '#f97316' },
        medium: { name: 'Medium (4.0-6.9)', children: [], color: '#eab308' },
        low: { name: 'Low (<4.0)', children: [], color: '#3b82f6' },
      }

      vulnerabilities.forEach(v => {
        const score = v.cvss_score || 0
        const category = score >= 9 ? 'critical' : score >= 7 ? 'high' : score >= 4 ? 'medium' : 'low'
        groups[category].children.push({
          name: v.cve_id,
          size: Math.max(score, 1) * 10,
          cvss_score: score,
          kev_date: v.kev_date,
          description: v.description,
          affected_vendors: v.affected_vendors,
        })
      })

      return Object.values(groups).filter(g => g.children.length > 0)
    }

    // Group by vendor
    const vendorMap = {}

    vulnerabilities.forEach(v => {
      const vendors = v.affected_vendors?.length > 0 ? v.affected_vendors : ['Unknown']
      const primaryVendor = vendors[0]

      if (!vendorMap[primaryVendor]) {
        vendorMap[primaryVendor] = {
          name: primaryVendor,
          children: [],
        }
      }

      vendorMap[primaryVendor].children.push({
        name: v.cve_id,
        size: Math.max(v.cvss_score || 1, 1) * 10,
        cvss_score: v.cvss_score,
        kev_date: v.kev_date,
        description: v.description,
        affected_vendors: v.affected_vendors,
      })
    })

    // Sort vendors by total CVSS
    return Object.values(vendorMap)
      .map(v => ({
        ...v,
        totalCvss: v.children.reduce((sum, c) => sum + (c.cvss_score || 0), 0),
      }))
      .sort((a, b) => b.totalCvss - a.totalCvss)
      .slice(0, 20)
  }, [vulnerabilities, groupBy])

  // Stats
  const stats = useMemo(() => {
    const kevCount = vulnerabilities.filter(v => v.kev_date).length
    const criticalCount = vulnerabilities.filter(v => v.cvss_score >= 9).length
    const avgCvss = vulnerabilities.length > 0
      ? vulnerabilities.reduce((sum, v) => sum + (v.cvss_score || 0), 0) / vulnerabilities.length
      : 0

    return { total: vulnerabilities.length, kevCount, criticalCount, avgCvss }
  }, [vulnerabilities])

  const handleClick = (data) => {
    if (data.name?.startsWith('CVE-') && onCveClick) {
      onCveClick(data.name)
    } else if (data.children) {
      setSelectedVendor(selectedVendor === data.name ? null : data.name)
    }
  }

  // Get data for current view
  const displayData = useMemo(() => {
    if (selectedVendor && groupBy === 'vendor') {
      const vendor = treemapData.find(v => v.name === selectedVendor)
      return vendor?.children || []
    }
    return treemapData
  }, [treemapData, selectedVendor, groupBy])

  return (
    <div className="space-y-3">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <h3 className="text-sm font-medium text-white">Vulnerability Treemap</h3>
          {selectedVendor && (
            <>
              <span className="text-gray-500">â€º</span>
              <span className="text-cyan-400">{selectedVendor}</span>
              <button
                onClick={() => setSelectedVendor(null)}
                className="text-xs text-gray-500 hover:text-gray-300"
              >
                (back)
              </button>
            </>
          )}
        </div>
        <div className="flex items-center gap-4 text-xs text-gray-400">
          <span>{stats.total} CVEs</span>
          <span className="text-red-400">{stats.kevCount} KEV</span>
          <span>{stats.criticalCount} critical</span>
          <span>Avg: {stats.avgCvss.toFixed(1)}</span>
        </div>
      </div>

      {loading ? (
        <div className="flex items-center justify-center" style={{ height }}>
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-500" />
        </div>
      ) : displayData.length === 0 ? (
        <div className="flex items-center justify-center text-gray-500" style={{ height }}>
          No vulnerability data available
        </div>
      ) : (
        <div style={{ height }}>
          <ResponsiveContainer width="100%" height="100%">
            <Treemap
              data={displayData}
              dataKey="size"
              aspectRatio={4 / 3}
              stroke="#374151"
              fill="#1f2937"
              content={<CustomizedContent />}
              onClick={handleClick}
            >
              <Tooltip content={<CustomTooltip />} />
            </Treemap>
          </ResponsiveContainer>
        </div>
      )}

      {/* Legend */}
      <div className="flex items-center justify-between text-xs">
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-1">
            <div className="w-3 h-3 rounded" style={{ backgroundColor: '#dc2626' }} />
            <span className="text-gray-400">KEV Critical</span>
          </div>
          <div className="flex items-center gap-1">
            <div className="w-3 h-3 rounded" style={{ backgroundColor: '#ef4444' }} />
            <span className="text-gray-400">KEV High</span>
          </div>
          <div className="flex items-center gap-1">
            <div className="w-3 h-3 rounded" style={{ backgroundColor: '#f97316' }} />
            <span className="text-gray-400">Critical</span>
          </div>
          <div className="flex items-center gap-1">
            <div className="w-3 h-3 rounded" style={{ backgroundColor: '#fb923c' }} />
            <span className="text-gray-400">High</span>
          </div>
        </div>
        <div className="text-gray-500">
          Box size = CVSS score
        </div>
      </div>
    </div>
  )
}

// Dashboard widget version
export function VulnerabilityTreemapMini({ onViewFull }) {
  return (
    <div className="cyber-card p-4">
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-sm font-medium text-white">CVE Landscape</h3>
        {onViewFull && (
          <button
            onClick={onViewFull}
            className="text-xs text-cyan-400 hover:text-cyan-300"
          >
            Expand
          </button>
        )}
      </div>
      <VulnerabilityTreemap days={30} limit={50} height={200} groupBy="flat" kevOnly />
    </div>
  )
}
