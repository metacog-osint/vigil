/**
 * VulnerabilityActorsPanel
 * Shows which threat actors are known to exploit a specific CVE
 */

import { useState, useEffect } from 'react'
import { Link } from 'react-router-dom'
import { correlations } from '../../lib/supabase'
import { TrendBadge } from '../badges'

function LoadingState() {
  return (
    <div className="space-y-3">
      {[1, 2, 3].map((i) => (
        <div key={i} className="animate-pulse">
          <div className="h-12 bg-gray-800 rounded"></div>
        </div>
      ))}
    </div>
  )
}

function ConfidenceBadge({ confidence }) {
  const colors = {
    high: 'bg-green-900/50 text-green-400 border-green-700/50',
    medium: 'bg-yellow-900/50 text-yellow-400 border-yellow-700/50',
    low: 'bg-gray-800 text-gray-400 border-gray-700',
  }

  return (
    <span className={`px-1.5 py-0.5 text-xs rounded border ${colors[confidence] || colors.low}`}>
      {confidence}
    </span>
  )
}

function ActorItem({ actor, firstSeen, lastSeen, confidence, source }) {
  return (
    <Link
      to={`/actors?selected=${actor?.id}`}
      className="block p-3 bg-gray-800/50 rounded border border-gray-700/50 hover:border-cyber-accent/50 transition-colors"
    >
      <div className="flex items-center justify-between gap-2">
        <div className="flex items-center gap-2 min-w-0">
          <span className="font-medium text-white truncate">
            {actor?.name || 'Unknown Actor'}
          </span>
          {actor?.trend_status && (
            <TrendBadge status={actor.trend_status} showLabel={false} />
          )}
        </div>
        <ConfidenceBadge confidence={confidence} />
      </div>

      {actor?.target_sectors?.length > 0 && (
        <div className="mt-2 flex flex-wrap gap-1">
          {actor.target_sectors.slice(0, 3).map((sector) => (
            <span
              key={sector}
              className="px-1.5 py-0.5 text-xs rounded bg-gray-700/50 text-gray-400"
            >
              {sector}
            </span>
          ))}
          {actor.target_sectors.length > 3 && (
            <span className="px-1.5 py-0.5 text-xs rounded bg-gray-700/50 text-gray-500">
              +{actor.target_sectors.length - 3}
            </span>
          )}
        </div>
      )}

      <div className="mt-2 flex items-center gap-4 text-xs text-gray-500">
        {firstSeen && (
          <span>First seen: {new Date(firstSeen).toLocaleDateString()}</span>
        )}
        {source && (
          <span className="text-gray-600">Source: {source}</span>
        )}
      </div>
    </Link>
  )
}

export default function VulnerabilityActorsPanel({ cveId }) {
  const [actors, setActors] = useState([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(null)

  useEffect(() => {
    async function loadActors() {
      if (!cveId) return

      setLoading(true)
      setError(null)

      try {
        const { data, error: fetchError } = await correlations.getVulnActors(cveId)

        if (fetchError) throw fetchError

        setActors(data || [])
      } catch (err) {
        console.error('Error loading vulnerability actors:', err)
        setError('Failed to load actors')
      } finally {
        setLoading(false)
      }
    }

    loadActors()
  }, [cveId])

  if (loading) {
    return (
      <div className="mt-4">
        <h4 className="text-sm font-medium text-gray-400 mb-3 flex items-center gap-2">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
          Threat Actors Exploiting This CVE
        </h4>
        <LoadingState />
      </div>
    )
  }

  if (error) {
    return (
      <div className="mt-4">
        <h4 className="text-sm font-medium text-gray-400 mb-3">Threat Actors</h4>
        <div className="text-sm text-red-400">{error}</div>
      </div>
    )
  }

  if (actors.length === 0) {
    return (
      <div className="mt-4">
        <h4 className="text-sm font-medium text-gray-400 mb-3 flex items-center gap-2">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
          Threat Actors
        </h4>
        <div className="p-4 bg-gray-800/50 rounded border border-gray-700/50 text-center">
          <p className="text-sm text-gray-500">
            No known actors exploiting this vulnerability
          </p>
        </div>
      </div>
    )
  }

  return (
    <div className="mt-4">
      <h4 className="text-sm font-medium text-gray-400 mb-3 flex items-center gap-2">
        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        Threat Actors Exploiting This CVE
        <span className="ml-auto px-2 py-0.5 text-xs rounded-full bg-red-900/50 text-red-400 border border-red-700/50">
          {actors.length}
        </span>
      </h4>

      <div className="space-y-2">
        {actors.map((item) => (
          <ActorItem
            key={item.actor_id || item.actor?.id}
            actor={item.actor}
            firstSeen={item.first_seen || item.first_observed}
            lastSeen={item.last_seen || item.last_observed}
            confidence={item.confidence}
            source={item.source}
          />
        ))}
      </div>

      {actors.length > 0 && (
        <div className="mt-3 text-xs text-gray-500 flex items-center gap-2">
          <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Click an actor to view their full profile
        </div>
      )}
    </div>
  )
}
