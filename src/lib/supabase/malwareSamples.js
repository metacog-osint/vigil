/**
 * Malware Samples Module
 * Database queries for malware sample management
 */

import { supabase } from './client'

export const malwareSamples = {
  async getRecent(options = {}) {
    const { limit = 50, offset = 0, signature = '', days = 30 } = options

    let query = supabase
      .from('malware_samples')
      .select('*', { count: 'exact' })
      .order('first_seen', { ascending: false })
      .range(offset, offset + limit - 1)

    if (days > 0) {
      const cutoffDate = new Date()
      cutoffDate.setDate(cutoffDate.getDate() - days)
      query = query.gte('first_seen', cutoffDate.toISOString())
    }

    if (signature) {
      query = query.eq('signature', signature)
    }

    return query
  },

  async searchHash(hash) {
    return supabase
      .from('malware_samples')
      .select('*')
      .or(`sha256.eq.${hash},sha1.eq.${hash},md5.eq.${hash}`)
      .single()
  },

  async getBySignature(signature, limit = 50) {
    return supabase
      .from('malware_samples')
      .select('*')
      .eq('signature', signature)
      .order('first_seen', { ascending: false })
      .limit(limit)
  },

  async getSignatureSummary() {
    const { data } = await supabase
      .from('malware_samples')
      .select('signature')
      .not('signature', 'is', null)

    const counts = {}
    for (const row of (data || [])) {
      if (row.signature) {
        counts[row.signature] = (counts[row.signature] || 0) + 1
      }
    }
    return counts
  },
}

export default malwareSamples
